x-healthcheck: &healthcheck
  interval: 30s
  timeout: 5s
  retries: 3
  start_period: 10s

x-restart: &restart
  restart: unless-stopped

x-resource-limits: &resource-limits
  mem_limit: 512m
  cpus: "1.0"
  pids_limit: 100

x-resource-limits-heavy: &resource-limits-heavy
  mem_limit: 1g
  cpus: "2.0"
  pids_limit: 200

x-security: &security
  read_only: true
  tmpfs:
    - /tmp
    - /home/mcpuser
  security_opt:
    - no-new-privileges:true

volumes:
  seclists-data:

networks:
  gateway:
    driver: bridge
  tools:
    driver: bridge
  e2e-targets:
    driver: bridge
    internal: true

services:
  # ─── Shared Builder (build-only, never started) ───
  shared-builder:
    build:
      context: .
      dockerfile: docker/Dockerfile.shared
    image: mcp-shared-builder:latest
    profiles: ["build-only"]

  # ─── SecLists Volume Provider (one-shot init) ───
  seclists-init:
    build:
      context: .
      dockerfile: docker/Dockerfile.seclists-data
    volumes:
      - seclists-data:/data
    restart: "no"

  # ─── Gateway ───
  gateway:
    build:
      context: .
      dockerfile: docker/Dockerfile.gateway
    ports:
      - "${GATEWAY_PORT:-8000}:8000"
    environment:
      - MCP_API_KEY=${MCP_API_KEY:-changeme}
    networks:
      - gateway
      - tools
    <<: *restart

  # ═══════════════════════════════════════════
  # Go Tools (17)
  # ═══════════════════════════════════════════

  alterx:
    build:
      context: .
      dockerfile: docker/Dockerfile.go
      args:
        SERVER_DIR: servers/alterx-mcp
        GO_PACKAGE: github.com/projectdiscovery/alterx/cmd/alterx
        TOOL_BIN: alterx
    command: ["/usr/local/bin/alterx", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  asnmap:
    build:
      context: .
      dockerfile: docker/Dockerfile.go
      args:
        SERVER_DIR: servers/asnmap-mcp
        GO_PACKAGE: github.com/projectdiscovery/asnmap/cmd/asnmap
        TOOL_BIN: asnmap
    command: ["/usr/local/bin/asnmap", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    env_file:
      - path: .env
        required: false
    environment:
      - PDCP_API_KEY=${PDCP_API_KEY:-}
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  assetfinder:
    build:
      context: .
      dockerfile: docker/Dockerfile.go
      args:
        SERVER_DIR: servers/assetfinder-mcp
        GO_PACKAGE: github.com/tomnomnom/assetfinder
        TOOL_BIN: assetfinder
    command: ["/usr/local/bin/assetfinder", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    env_file:
      - path: .env
        required: false
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  cero:
    build:
      context: .
      dockerfile: docker/Dockerfile.go
      args:
        SERVER_DIR: servers/cero-mcp
        GO_PACKAGE: github.com/glebarez/cero
        TOOL_BIN: cero
    command: ["/usr/local/bin/cero", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  ffuf:
    build:
      context: .
      dockerfile: docker/Dockerfile.go
      args:
        SERVER_DIR: servers/ffuf-mcp
        GO_PACKAGE: github.com/ffuf/ffuf/v2
        TOOL_BIN: ffuf
    command: ["/usr/local/bin/ffuf", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    volumes:
      - seclists-data:/opt/seclists:ro
      - ./docker/e2e-wordlists:/wordlists:ro
    depends_on:
      seclists-init:
        condition: service_completed_successfully
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits-heavy, *security]

  gau:
    build:
      context: .
      dockerfile: docker/Dockerfile.go
      args:
        SERVER_DIR: servers/gau-mcp
        GO_PACKAGE: github.com/lc/gau/v2/cmd/gau
        TOOL_BIN: gau
    command: ["/usr/local/bin/gau", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  github-subdomains:
    build:
      context: .
      dockerfile: docker/Dockerfile.go
      args:
        SERVER_DIR: servers/github-subdomains-mcp
        GO_PACKAGE: github.com/gwen001/github-subdomains
        TOOL_BIN: github-subdomains
    command: ["/usr/local/bin/github-subdomains", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    env_file:
      - path: .env
        required: false
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  gobuster:
    build:
      context: .
      dockerfile: docker/Dockerfile.go
      args:
        SERVER_DIR: servers/gobuster-mcp
        GO_PACKAGE: github.com/OJ/gobuster/v3
        TOOL_BIN: gobuster
    command: ["/usr/local/bin/gobuster", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    volumes:
      - seclists-data:/opt/seclists:ro
      - ./docker/e2e-wordlists:/wordlists:ro
    depends_on:
      seclists-init:
        condition: service_completed_successfully
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits-heavy, *security]

  gowitness:
    build:
      context: .
      dockerfile: docker/Dockerfile.go
      args:
        SERVER_DIR: servers/gowitness-mcp
        GO_PACKAGE: github.com/sensepost/gowitness
        TOOL_BIN: gowitness
    command: ["/usr/local/bin/gowitness", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  hakrawler:
    build:
      context: .
      dockerfile: docker/Dockerfile.go
      args:
        SERVER_DIR: servers/hakrawler-mcp
        GO_PACKAGE: github.com/hakluke/hakrawler
        TOOL_BIN: hakrawler
    command: ["/usr/local/bin/hakrawler", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  httpx:
    build:
      context: .
      dockerfile: docker/Dockerfile.go
      args:
        SERVER_DIR: servers/httpx-mcp
        GO_PACKAGE: github.com/projectdiscovery/httpx/cmd/httpx
        TOOL_BIN: httpx
    command: ["/usr/local/bin/httpx", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  katana:
    build:
      context: .
      dockerfile: docker/Dockerfile.go
      args:
        SERVER_DIR: servers/katana-mcp
        GO_PACKAGE: github.com/projectdiscovery/katana/cmd/katana
        TOOL_BIN: katana
    command: ["/usr/local/bin/katana", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  naabu:
    build:
      context: .
      dockerfile: docker/Dockerfile.naabu
      args:
        SERVER_DIR: servers/naabu-mcp
    command: ["/usr/local/bin/naabu", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    cap_drop: ["ALL"]
    cap_add: ["NET_RAW"]
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  nuclei:
    build:
      context: .
      dockerfile: docker/Dockerfile.go
      args:
        SERVER_DIR: servers/nuclei-mcp
        GO_PACKAGE: github.com/projectdiscovery/nuclei/v3/cmd/nuclei
        TOOL_BIN: nuclei
    command: ["/usr/local/bin/nuclei", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    env_file:
      - path: .env
        required: false
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits-heavy, *security]

  subfinder:
    build:
      context: .
      dockerfile: docker/Dockerfile.go
      args:
        SERVER_DIR: servers/subfinder-mcp
        GO_PACKAGE: github.com/projectdiscovery/subfinder/v2/cmd/subfinder
        TOOL_BIN: subfinder
    command: ["/usr/local/bin/subfinder", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    env_file:
      - path: .env
        required: false
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  waybackurls:
    build:
      context: .
      dockerfile: docker/Dockerfile.go
      args:
        SERVER_DIR: servers/waybackurls-mcp
        GO_PACKAGE: github.com/tomnomnom/waybackurls
        TOOL_BIN: waybackurls
    command: ["/usr/local/bin/waybackurls", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  shuffledns:
    build:
      context: .
      dockerfile: docker/Dockerfile.shuffledns
    command: ["/usr/local/bin/shuffledns", "/usr/local/bin/massdns", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    volumes:
      - seclists-data:/opt/seclists:ro
      - ./docker/e2e-wordlists:/wordlists:ro
    depends_on:
      seclists-init:
        condition: service_completed_successfully
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  # ═══════════════════════════════════════════
  # System Tools (3)
  # ═══════════════════════════════════════════

  nmap:
    build:
      context: .
      dockerfile: docker/Dockerfile.system
      args:
        SERVER_DIR: servers/nmap-mcp
        APT_PACKAGES: nmap
    command: ["/usr/bin/nmap", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    cap_drop: ["ALL"]
    cap_add: ["NET_RAW", "NET_ADMIN"]
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  masscan:
    build:
      context: .
      dockerfile: docker/Dockerfile.system
      args:
        SERVER_DIR: servers/masscan-mcp
        APT_PACKAGES: masscan
    command: ["/usr/bin/masscan", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    cap_drop: ["ALL"]
    cap_add: ["NET_RAW", "NET_ADMIN"]
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits-heavy, *security]

  sslscan:
    build:
      context: .
      dockerfile: docker/Dockerfile.system
      args:
        SERVER_DIR: servers/sslscan-mcp
        APT_PACKAGES: sslscan
    command: ["/usr/bin/sslscan", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  # ═══════════════════════════════════════════
  # Python Pip Tools (2)
  # ═══════════════════════════════════════════

  arjun:
    build:
      context: .
      dockerfile: docker/Dockerfile.python-pip
      args:
        SERVER_DIR: servers/arjun-mcp
        PIP_PACKAGE: arjun
    command: ["/opt/venv/bin/arjun", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    volumes:
      - seclists-data:/opt/seclists:ro
    depends_on:
      seclists-init:
        condition: service_completed_successfully
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  scoutsuite:
    build:
      context: .
      dockerfile: docker/Dockerfile.python-pip
      args:
        SERVER_DIR: servers/scoutsuite-mcp
        PIP_PACKAGE: scoutsuite
    command: ["/opt/venv/bin/scout", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    env_file:
      - path: .env
        required: false
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  # ═══════════════════════════════════════════
  # Python Git Tools (3)
  # ═══════════════════════════════════════════

  commix:
    build:
      context: .
      dockerfile: docker/Dockerfile.python-git
      args:
        SERVER_DIR: servers/commix-mcp
        GIT_REPO: https://github.com/commixproject/commix.git
        CLONE_DIR: /opt/commix
    command: ["python3", "/opt/commix/commix.py", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  smuggler:
    build:
      context: .
      dockerfile: docker/Dockerfile.python-git
      args:
        SERVER_DIR: servers/smuggler-mcp
        GIT_REPO: https://github.com/defparam/smuggler.git
        CLONE_DIR: /opt/smuggler
    command: ["python3", "/opt/smuggler/smuggler.py", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  sqlmap:
    build:
      context: .
      dockerfile: docker/Dockerfile.python-git
      args:
        SERVER_DIR: servers/sqlmap-mcp
        GIT_REPO: https://github.com/sqlmapproject/sqlmap.git
        CLONE_DIR: /opt/sqlmap
    command: ["python3", "/opt/sqlmap/sqlmap.py", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  # ═══════════════════════════════════════════
  # Ruby Tools (1)
  # ═══════════════════════════════════════════

  wpscan:
    build:
      context: .
      dockerfile: docker/Dockerfile.ruby
      args:
        SERVER_DIR: servers/wpscan-mcp
        GEM_PACKAGE: wpscan
    command: ["wpscan", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    env_file:
      - path: .env
        required: false
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits-heavy, *security]

  # ═══════════════════════════════════════════
  # Shell Tools (1)
  # ═══════════════════════════════════════════

  testssl:
    build:
      context: .
      dockerfile: docker/Dockerfile.shell
      args:
        SERVER_DIR: servers/testssl-mcp
        GIT_REPO: https://github.com/testssl/testssl.sh.git
        CLONE_DIR: /opt/testssl
    command: ["/opt/testssl/testssl.sh", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  # ═══════════════════════════════════════════
  # C++ Tools (1)
  # ═══════════════════════════════════════════

  urldedupe:
    build:
      context: .
      dockerfile: docker/Dockerfile.urldedupe
    command: ["/usr/local/bin/urldedupe", "--transport", "http", "--port", "3000"]
    expose: ["3000"]
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  # ═══════════════════════════════════════════
  # API-Only Tools (4)
  # ═══════════════════════════════════════════

  crtsh:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
      args:
        SERVER_DIR: servers/crtsh-mcp
    command: ["--transport", "http", "--port", "3000"]
    expose: ["3000"]
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  http-headers-security:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
      args:
        SERVER_DIR: servers/http-headers-security-mcp
    command: ["--transport", "http", "--port", "3000"]
    expose: ["3000"]
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  mobsf:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
      args:
        SERVER_DIR: servers/mobsf-mcp
    command: ["--transport", "http", "--port", "3000"]
    expose: ["3000"]
    environment:
      - MOBSF_API_KEY=${MOBSF_API_KEY:-}
      - MOBSF_URL=${MOBSF_URL:-}
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  shodan:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
      args:
        SERVER_DIR: servers/shodan-mcp
    command: ["--transport", "http", "--port", "3000"]
    expose: ["3000"]
    environment:
      - SHODAN_API_KEY=${SHODAN_API_KEY:-}
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
    networks: ["tools"]
    <<: [*restart, *resource-limits, *security]

  # ═══════════════════════════════════════════
  # E2E Test Targets
  # ═══════════════════════════════════════════

  httpbin:
    image: kennethreitz/httpbin:latest
    ports: ["${HTTPBIN_PORT:-8081}:80"]
    profiles: ["e2e"]
    healthcheck:
      <<: *healthcheck
      test: ["CMD-SHELL", "curl -sf http://localhost:80/ || exit 1"]
    networks:
      - tools
      - e2e-targets
    <<: *restart

  dvwa:
    image: ghcr.io/digininja/dvwa:latest
    ports: ["${DVWA_PORT:-8082}:80"]
    profiles: ["e2e"]
    environment:
      - DB_SERVER=dvwa-db
    depends_on:
      dvwa-db:
        condition: service_healthy
    healthcheck:
      <<: *healthcheck
      test: ["CMD-SHELL", "curl -sf http://localhost:80/ || exit 1"]
    networks:
      - tools
      - e2e-targets
    <<: *restart

  dvwa-db:
    image: mariadb:10
    expose: ["3306"]
    profiles: ["e2e"]
    environment:
      - MYSQL_ROOT_PASSWORD=${DVWA_DB_ROOT_PASSWORD:-dvwa}
      - MYSQL_DATABASE=dvwa
      - MYSQL_USER=dvwa
      - MYSQL_PASSWORD=${DVWA_DB_PASSWORD:-p@ssw0rd}
    healthcheck:
      <<: *healthcheck
      test: ["CMD-SHELL", "mysqladmin ping -h localhost"]
    networks: ["e2e-targets"]
    <<: *restart

  wordpress:
    image: wordpress:latest
    ports: ["${WORDPRESS_PORT:-8083}:80"]
    profiles: ["e2e"]
    environment:
      - WORDPRESS_DB_HOST=wordpress-db
      - WORDPRESS_DB_USER=wp
      - WORDPRESS_DB_PASSWORD=${WORDPRESS_DB_PASSWORD:-wp}
      - WORDPRESS_DB_NAME=wordpress
    depends_on:
      wordpress-db:
        condition: service_healthy
    healthcheck:
      <<: *healthcheck
      test: ["CMD-SHELL", "curl -sf http://localhost:80/ || exit 1"]
    networks:
      - tools
      - e2e-targets
    <<: *restart

  wordpress-db:
    image: mariadb:10
    expose: ["3306"]
    profiles: ["e2e"]
    environment:
      - MYSQL_ROOT_PASSWORD=${WORDPRESS_DB_ROOT_PASSWORD:-wp}
      - MYSQL_DATABASE=wordpress
      - MYSQL_USER=wp
      - MYSQL_PASSWORD=${WORDPRESS_DB_PASSWORD:-wp}
    healthcheck:
      <<: *healthcheck
      test: ["CMD-SHELL", "mysqladmin ping -h localhost"]
    networks: ["e2e-targets"]
    <<: *restart
