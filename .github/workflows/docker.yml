name: Docker Build and Push

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Docker image tag (default: latest)'
        required: false
        default: 'latest'

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Build all images
        run: docker compose build

      - name: Tag and push images
        run: |
          TAG="${{ github.event.inputs.tag }}"
          # Get all service names from docker compose
          SERVICES=$(docker compose config --services)
          for svc in $SERVICES; do
            # Default compose image name
            SRC="mcp-for-security-${svc}"
            DST="dmarquesdev/mcp-${svc}:${TAG}"
            echo "Tagging ${SRC} -> ${DST}"
            docker tag "${SRC}" "${DST}"
            docker push "${DST}"
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag }}
          name: MCP for Security - ${{ github.event.inputs.tag }}
          body: |
            Docker images published to Docker Hub.

            **Quick start:**
            ```bash
            docker compose up
            ```

            **Individual images:**
            ```
            docker pull dmarquesdev/mcp-gateway:${{ github.event.inputs.tag }}
            docker pull dmarquesdev/mcp-nmap:${{ github.event.inputs.tag }}
            docker pull dmarquesdev/mcp-httpx:${{ github.event.inputs.tag }}
            ```

            All 28 tools available as `dmarquesdev/mcp-<tool>:${{ github.event.inputs.tag }}`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
