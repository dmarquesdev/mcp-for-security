# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

A monorepo of 28 MCP (Model Context Protocol) server implementations that wrap popular cybersecurity tools. Each server exposes security tools as MCP tools over stdio or HTTP transport, enabling AI assistants to invoke them. A shared utility library (`mcp-shared/`) provides secure spawn, path sanitization, ANSI stripping, and dual-transport bootstrap. Maintained by Cyprox (cyprox.io).

## Build Commands

### Build the shared library (must be built first)
```bash
cd mcp-shared && npm install && npm run build
```
All servers depend on `mcp-shared` via `"file:../mcp-shared"`. Build it before building any server.

### Build a single MCP server
```bash
cd <tool>-mcp && npm install && npm run build
```
`npm run build` runs `tsc` to compile TypeScript from `src/` to `build/index.js`.

### Build a single server with its tool dependencies
```bash
cd <tool>-mcp && ./build.sh
```
Each `build.sh` installs the underlying security tool (Go binary, Python package, etc.), runs `npm install && npm run build`, and updates the root `mcp-config.json` via `jq`.

### Build all servers (used in Docker)
```bash
./start.sh
```
Iterates all `*-mcp/` directories, runs each `build.sh`, then generates the unified `mcp-config.json`.

### Docker build
```bash
docker build -t cyprox/mcp-for-security .
```
Multi-stage build on `golang:1.24-bullseye` installing Node.js v24, Python3, Ruby, and all security tools.

## Running an MCP Server

### Stdio transport (default)
```bash
node <tool>-mcp/build/index.js <binary-path> [additional-args]
```
Example: `node nmap-mcp/build/index.js nmap`

### HTTP transport
```bash
node <tool>-mcp/build/index.js <binary-path> --transport http --port 3001
```
All servers support both stdio and HTTP transport via `startServer()` from `mcp-shared`.

### MCP client configuration (stdio)
```json
{
  "mcpServers": {
    "nmap-mcp": {
      "command": "node",
      "args": ["/path/to/nmap-mcp/build/index.js", "nmap"]
    }
  }
}
```

## Testing

No automated test suite exists. Testing is manual via MCP client integration.

## Architecture

```
AI Assistant / MCP Client
        | MCP Protocol (JSON-RPC over stdio or HTTP)
        v
MCP Server Layer (Node.js TypeScript)
  - McpServer instance from @modelcontextprotocol/sdk
  - Tool registration via server.tool()
  - Input validation via Zod schemas
  - Shared utilities from mcp-shared/
        | secureSpawn / HTTP API
        v
Security Tool Layer
  - Go binaries (alterx, amass, httpx, katana, nuclei, etc.)
  - Python scripts (commix, sqlmap, scoutsuite, arjun)
  - System binaries (nmap, masscan, sslscan)
  - HTTP APIs (crt.sh, MobSF, http-headers-security)
```

### Shared Utility Library (`mcp-shared/`)

All 28 servers import from the `mcp-shared` local package:

| Module | Exports | Purpose |
|--------|---------|---------|
| `spawn.ts` | `secureSpawn()` | Spawn child processes with `stdio: ['ignore', 'pipe', 'pipe']`, 50MB output buffer limit, 5-minute timeout |
| `sanitize.ts` | `removeAnsiCodes()`, `truncateOutput()`, `sanitizePath()` | ANSI stripping, output truncation, path traversal prevention |
| `transport.ts` | `startServer()` | Dual stdio/HTTP transport bootstrap via `--transport` and `--port` CLI flags |
| `env.ts` | `getEnvOrArg()` | Prefer environment variables over CLI args for credentials |
| `args.ts` | `getToolArgs()` | Standardized CLI arg parsing — strips framework flags, validates min args, exits with usage on error |
| `result.ts` | `formatToolResult()` | Standardized MCP response — throws on nonzero exit, composes stdout/stderr, optional ANSI stripping |

### MCP Server Pattern (all servers follow this)

Every server in `src/index.ts`:
1. Parses CLI args via `getToolArgs(usage, minArgs?)` from `mcp-shared` — strips `--transport`/`--port` flags automatically
2. Creates `McpServer` instance
3. Registers one or more tools with Zod input schemas (naming convention: `do-<tool>`)
4. Calls `secureSpawn()` from `mcp-shared` (or makes HTTP calls for API-based tools)
5. Returns output via `formatToolResult(result, { toolName, includeStderr?, stripAnsi? })` — standardized error/output handling
6. Calls `startServer(server)` from `mcp-shared` for transport

### Two Execution Patterns

| Pattern | Used By | Mechanism |
|---------|---------|-----------|
| `secureSpawn` | All spawn-based tools (nmap, ffuf, httpx, nuclei, etc.) | Secure child process with stdin detached, buffer limits, timeout |
| HTTP/axios | crtsh, http-headers-security, mobsf | Direct API calls, no binary spawn |

**Note:** `node-pty` is no longer used. Go tools auto-suppress ANSI in pipe mode. Python tools use `removeAnsiCodes()` from `mcp-shared`.

### Config Generation

`mcp-config.json` at the repo root is auto-generated by `start.sh`/individual `build.sh` scripts. Each build script uses `jq` to add/update its entry. Do not edit this file manually.

## Conventions

- **Directory naming:** `<tool>-mcp/` (e.g., `nmap-mcp`, `httpx-mcp`). Exception: `cero/`
- **Tool function naming:** All use `do-<tool>` (e.g., `do-nmap`, `do-ffuf`, `do-httpx`, `do-amass`)
- **TypeScript target:** ES2022, module: Node16, strict mode
- **Core deps:** `@modelcontextprotocol/sdk` ^1.17.2, `zod`, `mcp-shared` (all servers)
- **ANSI stripping:** Import `removeAnsiCodes` from `mcp-shared` (only needed for Python tools)
- **Path safety:** Use `sanitizePath()` from `mcp-shared` when handling user-supplied file paths
- **Credential handling:** Use `getEnvOrArg()` from `mcp-shared` — prefers env vars over CLI args
- **Error handling:** Use `formatToolResult()` — automatically throws on nonzero exitCode with stderr details
- **CLI args:** Use `getToolArgs()` instead of manual `process.argv.slice(2)` parsing
- **Logging:** `console.error` for server status (stdout reserved for MCP protocol)
- **Spawn stdin:** Always detached via `stdio: ['ignore', 'pipe', 'pipe']` — critical for ProjectDiscovery Go tools that block on pipe stdin

## Adding a New MCP Server

1. Build `mcp-shared` first: `cd mcp-shared && npm install && npm run build`
2. Create `<tool>-mcp/` directory following existing structure
3. Copy `tsconfig.json` from any existing server (they're identical)
4. Create `package.json` with `@modelcontextprotocol/sdk` ^1.17.2, `zod`, and `"mcp-shared": "file:../mcp-shared"`
5. Implement `src/index.ts`:
 - Import `{ secureSpawn, startServer, getToolArgs, formatToolResult }` from `"mcp-shared"`
 - Use `getToolArgs()` to parse CLI args (strips `--transport`/`--port` automatically)
 - Name tools with `do-<tool>` convention
 - Use `secureSpawn()` to run the tool (or axios for API-based tools)
 - Use `formatToolResult()` for standardized response formatting
 - Call `await startServer(server)` in `main()`
6. Create `build.sh`: set `BIN_ARGS`, `SERVICE_PATH`, then `source scripts/build-common.sh`
7. Add entry to root `readme.md` tools table
8. Add the `.gitignore` file to make sure bloated files are not committed
9. Create the MCP server `readme.md` file describing its usage and setup

## Requirements
Use context7 for documentation
